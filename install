#!/usr/bin/env bash
# Dotfiles installation script
# Author: Rafael Cavalcanti

main() {
  # Initialize submodules.
  git submodule update --init --recursive

  # Create directories we don't want Stow to own.
  mkdir -p "$HOME/.config"
  mkdir -p "$HOME/.local/share"

  pick_install

  if $gui; then
    do_stow cli gui
    load_dconf
  else
    do_stow cli
  fi

  do_stow_host
}

log() {
  printf "%s\n" "$*" 1>&2
}

# args: command_to_check ...
check_cmd() {
  for cmd in "$@"; do
    if ! command -v $cmd >/dev/null; then
      printf "Install %s before running this script.\n" "$cmd"
      exit 1
    fi
  done
}

pick_install() {
  select option in "Only CLI" "CLI+GUI"; do
    case $option in
    "CLI+GUI")
      gui=true
      break
      ;;
    "Only CLI")
      gui=false
      break
      ;;
    *)
      printf "Invalid option.\n"
      ;;
    esac
  done
}

load_dconf() {
  check_cmd dconf

  log "Loading dconf settings..."
  cat dconf/*.conf | dconf load /
}

do_stow() {
  check_cmd stow

  log "Doing stow for $*..."
  stow -t ~ "$@"
}

do_stow_host() {
  case "$(hostname)" in
    localhost) local host="termux" ;;
    *) local host="$(hostname)" ;;
  esac

  [[ -d "hosts/${host}" ]] || return

  log "Found host specific files."
  cd hosts
  do_stow "${host}"
}

main "$@"
