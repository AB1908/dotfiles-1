#!/usr/bin/env bash
#
# dmenu script for choosing application to open URLs from clipboard.
#
# Copyright (C) 2021 Rafael Cavalcanti - rafaelc.org
# Licensed under GPLv3

readonly term="$TERMINAL"
readonly term_class="sys"

declare -Ar options=(
	["youtube-dl"]="ydl"
	["youtube-dl (audio)"]="ydl -x"
	["mpv"]="mpv"
	["umpv"]="umpv"
	["myt (queue)"]="myt --queue"
	["myt (play now)"]="myt --play-now"
	["Brave"]="brave-browser"
	["Brave (incognito)"]="brave-browser --incognito"
	["Chromium"]="chromium"
	["Chromium (incognito)"]="chromium --incognito"
	["Chromium temporary profile"]="chromium --temp-profile"
	["Firefox"]="firefox"
	["Firefox (private window)"]="firefox --private-window"
)

ydl() {
	local -r opts="$1"

	$term --class "$term_class" -e bash -c '
		trap '\''echo $(date +"%b %d %H:%M:%S") $@ >> ~/ydl_errors.log'\'' ERR

		mkdir -p ~/Downloads && cd ~/Downloads
		printf "Downloading these URLs:\n"
		printf "%s\n" "$@"
		printf

		youtube-dl '$opts' "$@"
	' --	"${urls[@]}"
}

declare -a urls=()
readonly url_regex='(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
while read -r url; do
	[[ ! $url =~ $url_regex ]] && continue
	urls+=("$url")
done < <(xclip -out -selection clipboard && printf '\n')

if [[ ${#urls[@]} -eq 0 ]]; then
	notify-send "dmenu" "No URLs on clipboard."
	exit
fi

readonly urls_str="${urls[*]}"
readonly prompt="Open ${#urls[@]}: ${urls_str::30}..."
readonly chosen="$(printf "%s\n" "${!options[@]}" | sort | dmenu -p "$prompt" -l 4 -g 4)"
[[ -z "$chosen" ]] && exit

readonly cmd="${options["$chosen"]}"
$cmd "${urls[@]}"

