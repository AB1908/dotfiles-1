#!/usr/bin/env bash
#
# Downloads random images from Unsplash API. Images are free to all uses.
# Based on https://github.com/omeryagmurlu/linux-unsplash-wallpaper
#
# Dependencies: wget, fdupes
#
# Copyright (C) 2017-2020 Rafael Cavalcanti - rafaelc.org
# Licensed under GPLv3

readonly script_name="$(basename "$0")"
readonly default_dest_dir="$WALLPAPERS"
readonly resolution="1920x1080"
readonly src_url="https://source.unsplash.com/random/${resolution}"
readonly wait_sec="2"

main() {
	check_args "$@"

	readonly n="$1"
	readonly dest_dir="${2:-$default_dest_dir}"

	download
	clean_dir
}

log() {
	printf "%s\t%s\n" "$(date)" "$*"
}

usage(){
	printf "Usage: %s n [dest_dir]\n" "$script_name"
	exit
}

check_args() {
	if [[ $# -ne 0 && $# -ne 1 ]]; then
		printf "Wrong number of arguments.\n"
		usage
	fi

	if [[ ! "$1" =~ ^[0-9]+$ ]]; then
		printf "First argument must be a number.\n"
		usage
	fi

	if [[ -n "$2" && ! -d "$2" ]]; then
		printf "'%s' is not a directory." "$2"
		usage
	fi
}

download() {
	log "Downloading to: ${dest_dir}"

	for i in $(seq 1 "$n"); do
		log "Downloading wallpaper ${i}/${n}..."

		local dest="${dest_dir}/$(date +%s).jpg"
		wget -q "$src_url" -O "$dest"

		sleep "$wait_sec"
	done
}

clean_dir() {
	log "Removing duplicates..."
	fdupes -rdN "$dest_dir"

	log "Removing 0 byte files..."
	find "$dest_dir" -maxdepth 0 -size 0 -delete
}

main "$@"
