#!/usr/bin/env bash
#
# Spotify wrapper. Features:
# - Only allow one instance.
# - Skip ads.
#
# Author: Rafael Cavalcanti - rafaelc.org

if wmctrl -xl | grep -q spotify.Spotify; then
  printf "Spotify is already running.\n"
  exit 1
fi

# Launch ad skipper
while true; do
  status="$(playerctl --player=spotify metadata --format="{{status}} {{title}}" 2>/dev/null)"

  if [[ "$status" =~ Playing\ \(Advertisement\|Spotify\) ]]; then
    playerctl --player=spotify next && notify-send --urgency=low "Spotify" "Attempted to skip Spotify ad."
  fi

  sleep 2s
done &

# Kill ad skipper on exit
trap 'kill $!; echo Killing ad skipper...' EXIT

flatpak run com.spotify.Client

# Workaround for Flatpak. On Flatpak, the above command exits immediately,
# killing the ad skipper.
while true; do
  sleep 10s
    if ! wmctrl -xl | grep -q spotify.Spotify; then
      break
    fi
done
