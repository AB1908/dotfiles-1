#!/usr/bin/env bash
#
# Launch webapps in Chromium browsers in app mode.
# Features:
# - Only allow one instance.
# - Use separate profile if desired.
#
# Copyright (C) 2020-2021 Rafael Cavalcanti - rafaelc.org
# Licensed under GPLv3

set -euo pipefail

readonly script_name="$(basename "$0")"
readonly browser="chromium"

declare -Ar apps=(
  [euinc]="https://docs.google.com/spreadsheets/d/14uu321lifzWad1456NsA6FgS8febTf64zDtL2nu29Is/"
  [messenger]="https://www.messenger.com/"
  [whatsapp]="https://web.whatsapp.com/"
)

# Empty for default
declare -Ar profiles=(
  [euinc]=""
  [messenger]="fb"
  [whatsapp]="fb"
)

usage() {
  printf "Usage: %s [app]\n" "$script_name"
  printf "Apps: %s\n" "${!apps[*]}"
  exit 1
}

[[ -z ${1:-} ]] && usage
readonly app="${1,,}" # lowercase

[[ -z "${apps[$app]+d}" ]] && printf "App doesn't exist.\n" && usage
readonly url="${apps[$app]}"

readonly class="$(sed 's#^https://##;s#/$##;s#.com/#.com__#g;s#/#_#g' <<< "$url")"
if wmctrl -xl | grep -q "$class"; then
  printf "App is already running.\n"
  exit
fi

readonly profile="${profiles[$app]:-}"
if [[ -n $profile ]]; then
  printf "Using separated profile: %s.\n" "$profile"
  readonly opt="--user-data-dir=$HOME/.config/webapp/$browser/$profile"
fi

exec "$browser" ${opt:-} --app="$url"
