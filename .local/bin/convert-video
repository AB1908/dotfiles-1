#!/bin/bash
#
# Some ffmpeg commands for my personal use. Called by my KDE Service Menus.
# Dependencies: ffmpeg
#
# Copyright (C) 2017-2019 Rafael Cavalcanti - rafaelc.org
# Licensed under GPLv3

usage() {
	cat << EOF
Usage: $(basename "$0") [option] [args]

Options:
  --to-mp4           Convert args to MP4.
  --to-480p          Convert args to 480p MP4.
  --to-360p          Convert args to 360p MP4.
  --dir-to-mp4       Convert all webm files in directories given by args to MP4. Delete originals.
  --concat           Concatenate args in MP4 format.
  --mute             Remove audio from args, without transcoding.

Arguments:
  [args]             Arguments - Dependent on the option.
EOF

	exit 1
}


to_mp4() {
	for arg
	do
		# Change destination name if source is already MP4
		if [ "${arg##*.}" == "mp4" ]
		then
			local name="${arg%.*}_mp4.mp4"
		else
			local name="${arg%.*}.mp4"
		fi
		ffmpeg -n -i "$arg" "$name"
	done
}

dir_to_mp4() {
	for arg
	do
		cd "$arg" || exit 1
		for path in *.webm
		do
			ffmpeg -n -i "$path" "${path%.*}.mp4" && rm "$path"
		done
	done
}

to_480p() {
	for arg
	do
		local output="${arg%.*}_480p.mp4"
		ffmpeg -n -i "$arg" -preset slow -codec:a aac -b:a 128k -codec:v libx264 -pix_fmt yuv420p -crf 24 -vf scale=854:480 "$output"
	done

}

to_360p() {
	for arg
	do
		local output="${arg%.*}_360p.mp4"
		ffmpeg -n -i "$arg" -preset slow -codec:a aac -b:a 128k -codec:v libx264 -pix_fmt yuv420p -crf 24 -vf scale=-1:360 "$output"
	done
}

concat(){
	local tmpfile=$(mktemp)
	for arg
	do
		# We need full paths, because our list file is in /tmp
		if [[ "$arg" = /* ]]
		then
			local name="$arg"
		else
			local name="${PWD}/${arg}"
		fi

		printf "file '%s'\n" "${name}"	>> "$tmpfile"
	done

	ffmpeg -f concat -safe -0 -i "$tmpfile" "concat_$(date +%s).mp4"
	rm "$tmpfile"
}

mute(){
	for arg
	do
		ffmpeg -i "$arg" -c copy -an "${arg%.*}_mute.${arg##*.}"
	done
}

# Check number of arguments
if [ "$#" -lt "2" ]
then
	usage
fi

# Call function
case $1 in
	--to-mp4)
		shift
		to_mp4 "$@"
		;;
	--dir-to-mp4)
		shift
		dir_to_mp4 "$@"
		;;
	--to-360p)
		shift
		to_360p "$@"
		;;
	--to-480p)
		shift
		to_480p "$@"
		;;
	--concat)
		shift
		concat "$@"
		;;
	--mute)
		shift
		mute "$@"
		;;
	*)
		usage
		;;
esac
