#!/usr/bin/env bash
#
# Copyright (C) 2020 Rafael Cavalcanti - rafaelc.org
# Licensed under GPLv3

readonly sep="|"

truncate() {
  local -r max_len=30
  local -r str="$*"

  if [[ ${#str} -gt $max_len ]]; then
    echo "${str::(( max_len - 3 ))}..."
  else
    echo "$str"
  fi
}

bar_vol() {
  if [[ "$(pulsemixer --get-mute)" == "1" ]]; then
    local -r icon="🔇"
  else
    local -r icon="🔊"
  fi

  echo "${icon} $(pulsemixer --get-volume | cut -f 1 -d ' ')%"
}

bar_player() {
  local -r cmd="playerctl --player=%any,chromium"
  local -r status="$($cmd status)"

  [[ "$status" =~ (Playing|Paused) ]] || return 0

  case $status in
    Playing) local -r icon=;;
    Paused) local -r icon=;;
  esac

  # Calling metadata with --format prevents mixing multiple players
  local artist="$($cmd metadata --format "{{ artist }}")"
  local title="$($cmd metadata --format "{{ title }}")"

  # Truncate long metadata
  artist="$(truncate "$artist")"
  title="$(truncate "$title")"

  echo "${icon} ${artist:+$artist -} ${title} ${sep} "
}

bar_date() {
  echo "$(date +"%a, %b %e")"
}

bar_time() {
  echo "🕐 $(date +"%R")"
}

bar_mem() {
  echo "Mem: $(free -h | grep '^Mem' | awk '{print $3}')"
}

xsetroot -name " $(bar_player)$(bar_vol) ${sep} $(bar_mem) ${sep} $(bar_date) ${sep} $(bar_time) "

